---
title : 'استقرارها'
---

# استقرارها

### جدول محتوا

## بررسی اجمالی

 استقرار به پروسه‌ای گفته می‌شود که کدهای پروژه شما از مخزن پروژه (معمولا در گیت‌هاب / گیت‌لب / گیت سفارشی ) دریافت می‌شود و در سرورتان در دایرکتوری پروژه قرار میگیرد. 
 
ما در پَچیم خروجی ۱۰ استقرار آخر برنامه شما را ذخیره می‌کنیم تا از وضعیت استقرارهای خود از طریق پنل پَچیم آگاه شوید و همچنین می‌توانید خروجی کد اسکریپت استقرار خود را نیز از طریق هر کدام مشاهده کنید، تا در صورت وجود مشکل، آن را بفهمید و حل کنید. 

## متغییرهای محیط‌ برنامه

بعضی از برنامه‌ها و پروژه‌ها از قابلیت متغییرهای محیط برنامه استفاده می‌کنند که با استفاده از فایل `.env` در مسیر اصلی پروژه مورد استفاده قرار میگیرد، برای مثال در یک پروژه لاراول این فایل نقش اساسی را در پیکربندی پروژه انجام می‌دهد. برای همین در پنل سایت پَچیم بخشی را بوجود آورده‌ایم با عنوان **متغییرهای محیط برنامه** که با استفاده از آن می‌توانید محتوای فایل `.env` را تغییر دهید و اگر این فایل اصلا وجود ندارد با استفاده از این بخش این فایل را با محتوای جدید ایجاد کنید. 

:::note{.tip}
::title[ساخت اتوماتیک `.env`]

فایل‌های `.env` را به هیچ وجه نباید به مخزن git اضافه کرد، اما می‌توانید همان فایل را بدون مقادیر حساس، تنها با اسم متغییرها در فایل `.env.example` قرار دهید و به مخزن git اضافه کرد. زمانی که شما پروژه را در پَچیم قرار می‌دهید، پَچیم بررسی می‌کند که اگر فایلی با عنوان `.env.example` وجود داشت آن به `.env` تغییر میدهد و سپس شما از طریق بخش متغییرهای محیط برنامه می‌توانید مقادیر آن را تغییر دهید.

:::

## استقرار سریع

ویژگی **استقرار سریع** پَچیم یکی از آن ویژگی‌هایست که زندگی برنامه‌نویسان را راحت‌تر می‌کند، در نظر داشته باشید که شما تغییری را در پروژه انجام دادید و قصد دارید تغییرات را بر روی وبسایت خود نمایش دهید، برای اینکار نیاز است بعد از push کردن تغییرات بر روی مخزن گیت وارد پنل پَچیم شوید و بر روی دکمه استقرار کلیک کنید تا تغییرات از مخزن گیت شما به سایت شما منتقل شود.

**اما** شما می‌توانید با فعال سازی گزینه‌ای با عنوان **استقرار سریع** از بخش اپلیکیشن در پَچیم، کاری کنید که هر زمان عمل push بر روی مخزن git پروژتان انجام شد، تغییرات مورد نظر به شکل اتوماتیک بر روی سرور شما قرار بگیرند و با این کار شما نیاز به انجام هیچ کار اضافه‌ای دیگری ندارید.

:::note{.warning}

::title[استفاده از مخزن‌های سفارشی]

توجه کنید امکان استفاده از ویژگی استقرار سریع `تنها برای مخزن‌های گیت هاب و گیت لب وجود دارد`، اما اگر از مخزن‌های سفارشی استفاده می‌کنید، می‌توانید از طریق `لینک درخواست استقرار` هر زمان که خواستید بهره ببرید و با فراخوانی این لینک درخواست استقرار در پروژه خود انجام دهید.

برای مثال این لینک را می‌توانید در گیت سفارشی خود قرار دهید تا با هر بار push کردن درخواستی را به شکل POST یا GET به لینک درخواست استقرار شما ارسال کند.

:::
## اسکریپت استقرار

بخش مهمی از پروسه استقرار، اسکریپت استقرار شماست، بخاطر اینکه مشخص می‌کند بعد از درخواست استقرار چه اتفاقی بر روی پروژه شما بی افتد، شما می‌توانید از طریق پنل پَچیم و بخش اپلیکیشن این اسکریپت را به هر روشی که مورد نیازتان بود تغییر دهید.

بر اساس نوع پروژه شما این اسکریپت استقرار متفاوت خواهد بود. برای مقال برای پروژه لاراولی به این شکل است که هر زمان اسکریپت استقرار انجام شد.

1. وارد دایرکتوری پروژه شما شود.
2. دستور git pull را برای دریافت آخرین تغییرات از مخزن git اجرا کند.
3. پکیج‌های مورد نیاز را با composer نصب کند.
4. در نهایت دستور `php artisan migrate` را اجرا کنید تا اگر فایل migration وجود داشت آن را بر روی سایت اجرا کند.

همچنین اگر متغییرهای را در فایل `.env` پروژه خود تعریف کرده‌اید که نیاز دارید در اسکریپت استقرار به آن‌ها دسترسی پیدا کنید، تنها کافیست، گزینه **فایل .env در استکریپت استقرار در دسترس باشد** را فعال کنید. زمانی که اینکار را انجام دهید، متغییرهای داخل فایل .env همانند متغییرهای معمول اسکریپت bash در اختیار شما قرار میگیرند.

```shell
echo "${APP_NAME} is deploying ..."
```
### ورژن PHP در استقرار

اگر شما [چندین ورژن از php را در سرور](/servers/php) خود نصب کرده‌اید، ممکن است نیاز داشته باشید از طریق اسکریپت استقرار خود به ورژن‌های مختلف PHP دسترسی پیدا کنید.

به شکل پیش فرض، اگر ورژنی از PHP را برای CLI انتخاب کنید با عنوان `php` می‌توانید همیشه از آن بهره ببرید، اما اگر در کنار ورژن پیشفرض قصد دارید به ورژن‌های مختلف نیز دسترسی داشته باشید، تنها کافیست نام باینری آن را به شکل `phpx.x` فراخوانی کنید، بجای `x.x` میتوانید عدد ورژن را قرار دهید. (`php8.0`)

### متغییر‌های محیط برنامه

در کنار اینکه شما می‌توانید به متغییر‌های فایل .env خود از طریق اسکریپت استقرار دسترسی داشته باشید ما در پَچیم یک سری از متغییرهای مربوط به سایت و استقرار شما را نیز از طریق اسکریپت استقرار در اختیارتان قرار می‌دهیم تا بتوانید اسکریپت استقرار خود را تا جای که ممکن است شخصی سازی کنید. 

| کلیدها                  | توضیحات                                                                                              |
|-------------------------|------------------------------------------------------------------------------------------------------|
| `PACHIM_COMPOSER`       | آدرس مسیری که composer در آن نصب شده است.                                                            |
| `PACHIM_CUSTOM_DEPLOY`  | اگر زمانی درخواست استقرار از طریق لینک اختصاصی درخواست استقرار، اجرا شود، مقدار این کد `1` خواهد شد. |
| `PACHIM_DEPLOY_AUTHOR`  | نویسنده کامیت.                                                                                       |
| `PACHIM_DEPLOY_COMMIT`  | هش مربوط به کامیتی که برای استقرار درخواست شده است.                                                  |
| `PACHIM_DEPLOY_MESSAGE` | پیام مربوط به کامیت.                                                                                 |
| `PACHIM_MANUAL_DEPLOY`  | زمانی که درخواست استقرار از طریق دکمه `استقرار جدید`، درخواست شود. مقدار این کلید `1` خواهد شد.      |
| `PACHIM_PHP_FPM`        | نام فرایند PHP-FPM که پَچیم برای شما در حال استفاده است.                                             |
| `PACHIM_PHP`            | نام باینری PHP که بر روی سایت شما استفاده می‌شود.                                                    |
| `PACHIM_QUICK_DEPLOY`   | زمانی که در خواست استقرار شما به روش استقرار سریع اجرا شده باشد، مقدار این کلید `1` خواهد شد.        |
| `PACHIM_REDEPLOY`       | اگر به هر دلیلی استقرار مورد نظر شما مجددا اجرا شود.                                                 |
| `PACHIM_SERVER_ID`      | آی دی سروری که استقرار بر روی آن در حال انجام است.                                                   |
| `PACHIM_SITE_BRANCH`    | نام شاخه‌ای که در حال استقرار است.                                                                   |
| `PACHIM_SITE_ID`        | آی دی وبسایت شما در پَچیم که استقرار بر روی آن در حال انجام است.                                     |
| `PACHIM_SITE_PATH`      | مسیری که استقرار بر روی آن انجام می‌شود. برای مثال `/home/pachim/mysite.com`                         |
| `PACHIM_SITE_USER`      | نام کاربر سایت شما که استقرار بر روی آن انجا می‌شود.                                                 |

شما می‌توانید برای مثال از از متغییر‌های بالا به شکل زیر استفاده کنید.
```bash
if [[ $PACHIM_QUICK_DEPLOY -eq 1 ]]; then
    echo "This deploy was triggered quick."
fi
```

برای مثال زمانی ممکن است شما بخواهید اگر کامیتی با متن `wip` (به معنی Work-in-Progress) بر روی مخزن push شد، باعث آپدیت شدن وبسایت شما نشود، برای همین می‌توانید از کد زیر در ابتدای اسکریپت استقرار استفاده کنید:

```bash
if [[ $PACHIM_DEPLOY_MESSAGE =~ "wip" ]]; then
    echo "WORK IN PROGRESS, DO NOT CONTINUE."
    exit 1
fi
```

:::note{.warning}

::title[از متغییرهای رزرو استفاده نکنید]

متغییرهای مربوط به پَچیم با `_PACHIM` شروع می‌شوند بنابراین اگر پروژه شما دارای فایل `.env` است و می‌خواهید متغییرهای آن در اسکریپت استقرار در دسترس باشد لطفا متغییرهای را با شروع `_PACHIM` تعریف نکنید.

:::

## توسعه با CI 

در حال کار بر روی پَچیم برای ارائه قابلیت کار با CI هستیم و به زودی مستندات لازم برای روش انجام این کار را در اختیار شما قرار خواهیم داد.

## ویرایش مخزن برنامه

گاهی اوقات ممکن است به هر دلیلی مکان قرار گیری مخزن گیت خود را تغییر دهید و بعد بخواهیم که این تغییر را بر روی پَچیم هم انجام دهید. پَچیم قابلیت انجام این کار را برای شما فراهم کرده که به سادگی و بدون نیاز به حذف و نصب مجدد اپلیکیشن خود و تنها با ورود به پنل پَچیم و قسمت اپلیکیشن وبسایت از طریق **ویرایش مخزن برنامه** اینکار را انجام دهید.

توجه کنید که ویرایش Repository باعث نمی‌شود فایل‌ها و کدهای موجود در وبسایتتان را تغییر کند، با انجام تغییر مخزن، تنها URL مربوط به git پروژه تغییر خواهد کرد، البته توجه داشته باشید برای آنکه این تغییر بدون مشکل انجام شود، مخزن جدیدی که وارد می‌کنید باید تماما با مخزن قبلی یکی باشد در غیر این صورت دچار مشکل خواهید شد، **همچنین پیشنهاد می‌کنیم که اگر قصد نصب و راه اندازی مخزن تماما جدید را دارید، ابتدا این برنامه را حذف کنید و سپس اقدام به نصب مخزن جدید در وبسایت خود کنید**.


## نوتیفیکیشن استقرارها

شما می‌توانید از طریق قسمت نوتیفیکیشن‌های سایت خود، کانال‌های که برای ارسال نوتیفیکیشن به شما مشخص می‌شود را مورد استفاده قرار دهید، دقت کنید که این بخش برای ارسال نوتیفیکیشن‌های مختلف از نوتیفیکیشن استقرار تا موارد دیگر مورد استفاده قرار خواهد گرفت.

### تلگرام

به زودی مستندات مربوط به نوتیفیکشن از طریق تلگرام در اینجا قرار خواهد گرفت.

### وب هوک

به زودی مستندات مربوط به وب هوک در این قسمت قرار خواهد گرفت.

### ایمیل

به زودی مستندات مربوط به وب هوک در اینجا قرار خواهد گرفت.
